name: firestore-ai-content-moderation
version: 0.1.0
specVersion: v1beta

displayName: AI Content Moderation

description: >-
  Automatically evaluates user-generated text in Firestore documents and applies configurable moderation actions.

author:
  authorName: DeuTale
  url: https://deutale.com

license: Apache-2.0

sourceUrl: https://github.com/eslamsaker100/firestore-ai-content-moderation

billingRequired: true

# IAM roles - minimum required
roles:
  - role: datastore.user
    reason: Required to read documents and write moderation results to Firestore.

# Extension resources
resources:
  - name: moderateContent
    type: firebaseextensions.v1beta.function
    description: >-
      Triggered when a new document is created in the specified collection.
      Evaluates the text content and applies moderation based on configuration.
    properties:
      eventTrigger:
        eventType: providers/cloud.firestore/eventTypes/document.create
        resource: projects/${PROJECT_ID}/databases/(default)/documents/${param:COLLECTION_PATH}/{docId}
      runtime: nodejs18

  - name: backfillModeration
    type: firebaseextensions.v1beta.function
    description: >-
      Processes existing documents when the extension is installed.
    properties:
      runtime: nodejs18
      taskQueueTrigger: {}

# User-configurable parameters
params:
  - param: COLLECTION_PATH
    label: Collection path
    description: >-
      The Firestore collection path to monitor for new documents.
      Use {wildcard} for subcollections, e.g., "posts/{postId}/comments".
    type: string
    default: comments
    required: true
    immutable: false

  - param: TEXT_FIELD
    label: Text field name
    description: >-
      The name of the document field containing the text to evaluate.
    type: string
    default: text
    required: true
    immutable: false

  - param: MODERATION_FIELD
    label: Moderation output field name
    description: >-
      The name of the field where moderation results will be written.
    type: string
    default: moderation
    required: true
    immutable: false

  - param: AI_PROVIDER
    label: AI provider
    description: >-
      Select the AI provider for content evaluation.
    type: select
    default: openai
    required: true
    options:
      - label: OpenAI Moderation API
        value: openai
      - label: Google Gemini
        value: gemini
      - label: Local rules (blocklist-based)
        value: local

  - param: OPENAI_API_KEY
    label: OpenAI API key
    description: >-
      Your OpenAI API key. Required if using OpenAI provider.
    type: secret
    required: false

  - param: GEMINI_API_KEY
    label: Gemini API key
    description: >-
      Your Google Gemini API key. Required if using Gemini provider.
    type: secret
    required: false

  - param: MODERATION_ACTION
    label: Moderation action
    description: >-
      Action to take when content is flagged.
    type: select
    default: flag
    required: true
    options:
      - label: Flag - Add moderation metadata, keep content visible
        value: flag
      - label: Hide - Set hidden field to true
        value: hide
      - label: Delete - Remove the document
        value: delete

  - param: SENSITIVITY
    label: Sensitivity threshold
    description: >-
      Minimum confidence score (0.0-1.0) to flag content. Lower values are more strict.
    type: string
    default: "0.5"
    required: true
    validationRegex: ^(0(\.\d+)?|1(\.0+)?)$
    validationErrorMessage: Must be a number between 0.0 and 1.0

  - param: BLOCKLIST_WORDS
    label: Blocklist words (for local provider)
    description: >-
      Comma-separated list of words to block when using the local provider.
    type: string
    default: ""
    required: false

  - param: ENABLE_EVENTS
    label: Enable Eventarc events
    description: >-
      Publish events via Eventarc when moderation completes.
    type: select
    default: "false"
    required: true
    options:
      - label: "Yes"
        value: "true"
      - label: "No"
        value: "false"

  - param: DO_BACKFILL
    label: Backfill existing documents
    description: >-
      Process existing documents in the collection when the extension is installed.
    type: select
    default: "false"
    required: true
    options:
      - label: "Yes"
        value: "true"
      - label: "No"
        value: "false"

# Lifecycle events
lifecycleEvents:
  onInstall:
    function: backfillModeration
    processingMessage: Processing existing documents

# Eventarc events (only used if ENABLE_EVENTS is true)
events:
  - type: firebase.extensions.firestore-ai-content-moderation.v1.moderated
    description: >-
      Published when content moderation completes. Contains the moderation result.

  - type: firebase.extensions.firestore-ai-content-moderation.v1.flagged
    description: >-
      Published when content is flagged.
